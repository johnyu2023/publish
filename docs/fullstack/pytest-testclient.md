---
title: Pytest + TestClient é‡æ„
description: ä»‹ç»äº†ä»SQLiteè¿ç§»åˆ°PostgreSQLåï¼Œä½¿ç”¨Pytest+TestClienté‡æ„åç«¯é¡¹ç›®æµ‹è¯•ç”¨ä¾‹çš„æ–¹æ¡ˆã€‚æ ¸å¿ƒæ˜¯é€šè¿‡fixtureå®ç°æµ‹è¯•æ•°æ®åº“éš”ç¦»ï¼Œç¡®ä¿æµ‹è¯•è¿æ¥æ­£ç¡®çš„æ•°æ®åº“ã€‚
date: 2026-01-01
tags: [pytest, testclient]
---

## èƒŒæ™¯æè¿°

+ ä¸€ä¸ªåç«¯é¡¹ç›®ï¼Œä¸»è¦æ˜¯å¯¹æ•°æ®åº“ä¸­8å¼ è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚ä¹‹å‰ä½¿ç”¨çš„æ˜¯ sqlite ï¼Œç°åœ¨æ•°æ®å·²ç»è¿ç§»åˆ°è¿œç¨‹çš„ postgresql ã€‚åç«¯åšäº†ä¸€äº›ä¿®æ”¹ï¼Œå¯åŠ¨åï¼Œéƒ¨åˆ†åŠŸèƒ½æ­£å¸¸ï¼Œéƒ¨åˆ†åŠŸèƒ½æœ‰é—®é¢˜ã€‚
+ é¡¹ç›®ä¹‹å‰æ˜¯æœ‰ä¸€äº›æµ‹è¯•ç”¨ä¾‹çš„ï¼Œä½¿ç”¨äº† Pytest + TestClient æŠ€æœ¯æ ˆã€‚ä¸è¿‡å®ƒä»¬ä¼¼ä¹éƒ¨åˆ†è¿˜æ˜¯é¡½å›ºåœ°è¿æ¥åˆ°äº†ä¹‹å‰çš„ sqlite ä¸­å»äº†ï¼Œè¿™è®©æˆ‘æ€€ç–‘è¿™äº›æµ‹è¯•ç”¨ä¾‹æ•´ä½“ä¸Šçš„å¯é æ€§ã€‚

## é‡æ„æ€è·¯

> ä¸éœ€è¦å½»åº•é‡å†™æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œä½†éœ€è¦ç³»ç»Ÿæ€§åœ°é‡æ„å’Œä¿®å¤ï¼Œä»¥ç¡®ä¿æµ‹è¯•çš„å¯é æ€§ã€å¯ç»´æŠ¤æ€§å’Œç¯å¢ƒéš”ç¦»æ€§ã€‚

### 1. é¦–è¦ä»»åŠ¡ï¼šéš”ç¦»æµ‹è¯•æ•°æ®åº“ï¼Œæœç»â€œè¿é”™åº“â€

+ **ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„ PostgreSQL æ•°æ®åº“**ï¼ˆå¦‚ `yourapp_test`ï¼‰ï¼Œè€Œéå¼€å‘æˆ–ç”Ÿäº§åº“ã€‚
+ åœ¨ `pytest` ä¸­é€šè¿‡ **fixture + ç¯å¢ƒå˜é‡** åŠ¨æ€æ³¨å…¥æ•°æ®åº“ URL

```python
   # conftest.py
   import os
   import pytest
   from sqlalchemy import create_engine
   from sqlalchemy.orm import sessionmaker
   from your_app.db import Base

   TEST_DB_URL = os.getenv("TEST_DATABASE_URL", "postgresql://user:pass@localhost/yourapp_test")

   @pytest.fixture(scope="session")
   def test_engine():
       engine = create_engine(TEST_DB_URL)
       Base.metadata.create_all(bind=engine)  # åˆ›å»ºæµ‹è¯•è¡¨ç»“æ„
       yield engine
       Base.metadata.drop_all(bind=engine)  # æ¸…ç†

   @pytest.fixture
   def db_session(test_engine):
       Session = sessionmaker(bind=test_engine)
       session = Session()
       try:
           yield session
       finally:
           session.rollback()
           session.close()
```

+ **ç¡®ä¿æ‰€æœ‰æµ‹è¯•æ–‡ä»¶é€šè¿‡ fixture æ³¨å…¥ sessionï¼Œè€Œéç›´æ¥ import å…¨å±€ session**ã€‚å¦åˆ™å®¹æ˜“æ±¡æŸ“ä¸»åº”ç”¨çš„æ•°æ®åº“è¿æ¥é…ç½®ã€‚

---
### 2. é‡æ„ç­–ç•¥ï¼šä¿ç•™é€»è¾‘ï¼Œæ›¿æ¢ä¾èµ–

> åŸæµ‹è¯•ç”¨ä¾‹ç»“æ„æ˜¯åˆç†çš„ï¼ˆåˆ†å±‚ï¼šAPI â†’ CRUD â†’ Modelï¼‰ï¼Œ**é€»è¾‘å¯å¤ç”¨ï¼Œåªéœ€ä¿®å¤æ•°æ®åº“è¿æ¥å’Œäº‹åŠ¡ç®¡ç†**ã€‚

+ **ä¿ç•™**ï¼šæµ‹è¯•åœºæ™¯ã€æ–­è¨€é€»è¾‘ã€è¾¹ç•Œæ¡ä»¶ï¼ˆå¦‚åˆ†é¡µã€æ—¥æœŸç­›é€‰ï¼‰ã€‚
+ **æ›¿æ¢/ä¿®å¤**ï¼š
  + æ‰€æœ‰æ•°æ®åº“è¿æ¥åˆå§‹åŒ–æ–¹å¼ï¼›
  + äº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆç¡®ä¿æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹åè‡ªåŠ¨æ¸…ç†æ•°æ®ï¼‰ï¼›
  + æ¨¡å‹åˆ›å»ºæ–¹å¼ï¼ˆç¡®ä¿ä½¿ç”¨æµ‹è¯• session è€Œéå…¨å±€ sessionï¼‰ã€‚

---
### 3. å…³é”®æ”¹è¿›ç‚¹

#### 1. **ç»Ÿä¸€æ•°æ®åº“è¿æ¥é…ç½®**

+ ä¸»åº”ç”¨å’Œæµ‹è¯•åº”é€šè¿‡ **åŒä¸€å¥—é…ç½®æœºåˆ¶**ï¼ˆå¦‚ Pydantic Settings æˆ–ç¯å¢ƒå˜é‡ï¼‰è¯»å– `DATABASE_URL`ã€‚
+ æµ‹è¯•æ—¶é€šè¿‡ `pytest --override-ini=...` æˆ– `env TEST_DATABASE_URL=... pytest` æŒ‡å®šæµ‹è¯•åº“ã€‚

#### 2. **ä½¿ç”¨äº‹åŠ¡å›æ»šå®ç°æµ‹è¯•éš”ç¦»**
å¯¹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œåœ¨ setup æ—¶å¼€å¯äº‹åŠ¡ï¼Œteardown æ—¶ rollbackï¼ˆè€Œé commitï¼‰ï¼Œé¿å…æ•°æ®æ®‹ç•™ã€‚ç¤ºä¾‹ï¼š

```python
@pytest.fixture
def clean_db(db_session):
    transaction = db_session.begin()
    yield db_session
    transaction.rollback()
```

#### 3. **åˆ é™¤å†—ä½™æµ‹è¯•æ–‡ä»¶**
åŸæœ‰ 9 ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå­˜åœ¨æ˜æ˜¾é‡å ï¼š

+ `test_db_connection.py`ã€`test_db_simple.py`ã€`test_db_operations.py` åŠŸèƒ½é«˜åº¦é‡å¤ â†’ **åˆå¹¶ä¸ºä¸€ä¸ª `test_database.py`**ã€‚
+ `test_login_logout.py` å’Œ `test_api_with_auth.py` ä¹Ÿæœ‰é‡å  â†’ **ä¿ç•™åè€…ï¼Œå‰è€…å¯åˆ **ã€‚
+ `test_weight_records.py` åŠŸèƒ½å·²è¢« `test_crud.py` å’Œ `test_api.py` è¦†ç›– â†’ **å¯åˆ é™¤æˆ–ä¿ç•™ä½œä¸ºä¸“é¡¹å‹åŠ›æµ‹è¯•**ã€‚

> ğŸ§¹ ç²¾ç®€ååº”ä¿ç•™ 4 ç±»æµ‹è¯•ï¼š
>
> 1. `test_models.py`ï¼ˆæ¨¡å‹ç»“æ„ï¼‰
> 2. `test_crud.py`ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
> 3. `test_api.py`ï¼ˆå«è®¤è¯çš„ç«¯åˆ°ç«¯ API æµ‹è¯•ï¼‰
> 4. `test_database.py`ï¼ˆè¿æ¥ä¸åŸºç¡€è¯»å†™ï¼‰

#### 4. **å¢åŠ  PostgreSQL ç‰¹æ€§å…¼å®¹æ€§æµ‹è¯•**
SQLite ä¸ PostgreSQL åœ¨ä»¥ä¸‹æ–¹é¢æœ‰å·®å¼‚ï¼Œéœ€ä¸“é¡¹éªŒè¯ï¼š

+ å¤§å°å†™æ•æ„Ÿï¼ˆPostgreSQL è¡¨å/åˆ—åé»˜è®¤å°å†™ï¼‰ï¼›
+ æ•°æ®ç±»å‹ï¼ˆå¦‚ `DATETIME` vs `TIMESTAMP`ï¼‰ï¼›
+ è‡ªå¢ ID è¡Œä¸ºï¼›
+ å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆ`ILIKE` vs `LIKE`ï¼‰ï¼›
+ åˆ†é¡µè¯­æ³•ï¼ˆè™½ç„¶ç”¨ ORM å¯èƒ½å±è”½äº†ï¼Œä½†éœ€ç¡®è®¤ï¼‰ã€‚

---

### 4. éªŒè¯è¿ç§»æ˜¯å¦æˆåŠŸï¼šå…³é”®æ£€æŸ¥æ¸…å•

| é¡¹ç›® | æ£€æŸ¥æ–¹å¼ |
|------|--------|
| æ‰€æœ‰æµ‹è¯•è¿æ¥çš„æ˜¯ PostgreSQL | åœ¨æµ‹è¯•ä¸­æ‰“å° `engine.url`ï¼Œç¡®è®¤æ—  `sqlite` |
| æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹ã€æ— çŠ¶æ€ | è¿è¡Œå•ä¸ªæµ‹è¯•ã€å¤šä¸ªæµ‹è¯•ã€ä¹±åºè¿è¡Œï¼Œç»“æœä¸€è‡´ |
| æ•°æ®åœ¨æµ‹è¯•åè‡ªåŠ¨æ¸…ç† | æµ‹è¯•ç»“æŸåæŸ¥è¡¨åº”ä¸ºç©ºæˆ–åˆå§‹çŠ¶æ€ |
| åˆ†é¡µ/ç­›é€‰/æ’åºç»“æœæ­£ç¡® | å¯¹æ¯” SQLite ä¸ PostgreSQL è¿”å›ç»“æœæ˜¯å¦ä¸€è‡´ |
| é”™è¯¯å¤„ç†æ­£å¸¸ï¼ˆå¦‚å”¯ä¸€çº¦æŸã€éç©ºçº¦æŸï¼‰ | PostgreSQL çº¦æŸæ›´ä¸¥æ ¼ï¼Œéœ€éªŒè¯å¼‚å¸¸è¢«æ•è· |

---

### 5. è¡ŒåŠ¨å»ºè®®ï¼ˆåˆ†æ­¥ï¼‰

1. **ç«‹å³**ï¼šå»ºç«‹ç‹¬ç«‹çš„ `yourapp_test` PostgreSQL æ•°æ®åº“ã€‚
2. **ä¿®æ”¹**ï¼šé…ç½®ç³»ç»Ÿï¼Œæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡åˆ‡æ¢ DB URLã€‚
3. **é‡æ„** `conftest.py`ï¼Œå¼•å…¥ fixture ç®¡ç†æµ‹è¯• DB ç”Ÿå‘½å‘¨æœŸã€‚
4. **é€ä¸ªä¿®å¤**æµ‹è¯•æ–‡ä»¶ï¼Œæ›¿æ¢ç¡¬ç¼–ç è¿æ¥ï¼Œä½¿ç”¨ fixture æ³¨å…¥ sessionã€‚
5. **åˆ é™¤å†—ä½™æµ‹è¯•æ–‡ä»¶**ï¼Œåˆå¹¶é‡å¤é€»è¾‘ã€‚
6. **è¿è¡Œå…¨é‡æµ‹è¯•**ï¼Œç¡®è®¤ï¼š
   + æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼›
   + æ— è¿æ¥ SQLite çš„æ—¥å¿—ï¼›
   + æµ‹è¯•æ•°æ®åº“åœ¨è¿è¡Œåä¸ºç©ºã€‚

## å‡†å¤‡ç¯å¢ƒ - æ•°æ®åº“

> pytest è¦æ±‚è¿æ¥åˆ°ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„ç©ºæ•°æ®åº“ä¸­

### ç”¨ PuTTY è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨

+ ç”¨ deploy è¿™ä¸ªç”¨æˆ·ç™»å½•åˆ°è¿œç¨‹æœåŠ¡å™¨

```bash
# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p ~/pg_migration
# è¿›å…¥å·¥ä½œç›®å½•
cd ~/pg_migration
# æ‰§è¡Œ pg_dump å‘½ä»¤ï¼Œå°†å¼€å‘æ•°æ®åº“çš„ schema å¯¼å‡ºåˆ° create_schema.sql æ–‡ä»¶ä¸­
pg_dump -h localhost -U kpfit_dev -d kpfit_dev_db --schema-only --no-owner --no-privileges -f create_schema.sql
```

### é€šè¿‡ FileZilla ä¸‹è½½ create_schema.sql æ–‡ä»¶

+ ç”¨ deploy è¿™ä¸ªç”¨æˆ·ï¼Œé€šè¿‡ FileZilla è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚æ³¨æ„ï¼šç”¨æˆ·åå’Œ PuTTY ä¸­é…ç½®çš„ä¸€è‡´ã€‚
+ ä»è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ `~/pg_migration` ç›®å½•ä¸‹è½½ `create_schema.sql` æ–‡ä»¶åˆ°æœ¬åœ°ã€‚

### DBeaver ä¸­æ‰§è¡Œ create_schema.sql æ–‡ä»¶

+ æ³¨æ„ï¼šDBeaver ä½œä¸ºä¸€ä¸ªæ ‡å‡†çš„ SQL å®¢æˆ·ç«¯ï¼Œä¸è®¤è¯† \ å¼€å¤´çš„å‘½ä»¤ï¼Œæ‰€ä»¥ä¼šæŠ¥è¯­æ³•é”™è¯¯ã€‚æ‰€ä»¥åº”å…ˆæŸ¥æ‰¾å¹¶åˆ é™¤æ‰€æœ‰ä»¥ \ å¼€å¤´çš„è¡Œï¼š
  + åˆ é™¤ç¬¬ä¸€è¡Œçš„ \restrict ...ã€‚
  + åˆ é™¤æœ€åä¸€è¡Œçš„ \unrestrict ...ã€‚

+ ç”¨ DBeaver è¿æ¥åˆ°æµ‹è¯•æ•°æ®åº“ï¼ˆ`kpfit_test_db`ï¼‰ã€‚
+ æ‰“å¼€ `create_schema.sql` æ–‡ä»¶ï¼Œç‚¹å‡»å³é”®é€‰æ‹© `Run as SQL Script`ã€‚
+ ç¡®è®¤æ‰§è¡Œåï¼Œæµ‹è¯•æ•°æ®åº“åº”åŒ…å«ä¸å¼€å‘æ•°æ®åº“ç›¸åŒçš„ schemaã€‚

## æµ‹è¯•ç”¨ä¾‹é‡æ„

### æ–‡ä»¶ç›®å½•ç»“æ„

```plaintext
    1 keepfit\
    2 â””â”€â”€ server\
    3     â””â”€â”€ tests\                 # pytest æµ‹è¯•ç”¨ä¾‹ä¸»ç›®å½•
    4         â”œâ”€â”€ __init__.py       # Python åŒ…æ ‡è¯†
    5         â”œâ”€â”€ conftest.py       # pytest é…ç½®å’Œ fixture å®šä¹‰
    6         â”œâ”€â”€ test_api.py       # API æ¥å£æµ‹è¯•
    7         â”œâ”€â”€ test_crud.py      # CRUD æ“ä½œæµ‹è¯•
    8         â”œâ”€â”€ test_database.py  # æ•°æ®åº“ç›¸å…³æµ‹è¯•
    9         â””â”€â”€ test_models.py    # æ•°æ®æ¨¡å‹æµ‹è¯•
```

### æµ‹è¯•ç”¨ä¾‹å¼€å‘é¡ºåº

**å¼€å‘é¡ºåº**ï¼ˆè‡ªåº•å‘ä¸Šï¼‰

+ `conftest.py` ï¼ˆå·¥è£…å¤¹å…·ï¼‰
+ `test_database.py` ï¼ˆéªŒè¯åœ°åŸºï¼‰
+ `test_models.py` ï¼ˆéªŒè¯ç –å—ï¼‰
+ `test_crud.py` ï¼ˆéªŒè¯ç Œå¢™ï¼‰
+ `test_api.py` ï¼ˆéªŒè¯æ•´æ ‹æ¥¼ï¼‰

### æµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œ

```bash
# éªŒè¯æ•°æ®åº“è¿æ¥
pytest -v tests/test_database.py
# éªŒè¯æ¨¡å‹
pytest -v tests/test_models.py
# éªŒè¯ CRUD æ“ä½œ
pytest -v tests/test_crud.py
# éªŒè¯ API æ¥å£
pytest -v tests/test_api.py
# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
pytest -v --tb=short
```
